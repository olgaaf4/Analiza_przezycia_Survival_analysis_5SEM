---
title: "Lista_3"
author: "Olga Foriasz"
date: "2025-10-15"
output:
  pdf_document: default
  html_document: default
header-includes:
- \usepackage[OT4]{polski}
- \usepackage[utf8]{inputenc}
- \usepackage{graphicx}
- \usepackage{float}
subtitle: Analiza przeżycia
fontsize: 11pt
---

# LISTA 4

## Zadanie 1 - Funkcja ilorazu wiarygodności

Zadanie zaczynamy od wygenerowania danych cenzurowanych I-go typu, które są realizacjami zmiennych losowych z rozkładu wykładniczego.

```{r, warning=FALSE}
generowanie_1 <- function(n,lambda){
  x <- rexp(n,lambda)
  x <- sort(x)
  t0 <- mean(x)
  delta <- numeric(n)
  delta[x<=t0]=1
  x[x>t0]=t0
  dane <- data.frame(x,delta)
  names(dane)<-c("czas","dane")
  return(dane)
}

##generowanie_1(10,1/2)
```

Następnie piszemy funkcję wyliczającą funkcję wiarygodności:

```{r, warning=FALSE}

L <- function(x, t0, r, theta) {
  n <- length(x$czas)
  return (factorial(n) / factorial(n - r) * theta^r *
           exp(-theta * (sum(x$czas[1:r]) + t0 * (n - r))))
}


```

Korzystając z wcześniejszych funckji deklarujemy następną, w której wartością zwracaną będzie wartość poziomu krytycznego w teście ilorazu wiarygodności do testowania hipotez dwustronnych (type="two.sided"), jednostronnych prawostronnie (type="greater"), jednostronnych lewostronnie (type="less"):

```{r, warning=FALSE}
IW <- function(x,t0,r,theta0,type){
  n <- length(x$czas)
  T1 <- sum(x$czas[1:r])+t0*(n-r)
  t <- r/T1
  mianownik <- L(x,t0, r, t)
  if(type=="two.sided"){
    licznik = L(x,t0, r, theta0)
  }
  if(type=="greater"){
    if(mianownik <= theta0){
      licznik=mianownik
    }else{licznik=L(x,t0, r, theta0)}
  }
  if(type=="less"){
    if(mianownik>theta0){
      licznik=mianownik
    }else{licznik=L(x,t0, r, theta0)}
  }
  lambda = licznik/mianownik
  G=-2*log(lambda)
  return(1-pchisq(G,1))
}
```

## Zadanie 2 

W tym zadaniu przeprowadzono symulacje mające na celu oszacowanie mocy testu ilorazu wiarygodności oraz jego rozmiaru dla wybranych wartości parametrów.

Założono, że badane dane pochodzą z rozkładu wykładniczego, a cenzurowanie jest typu I przy ustalonym czasie `t_0 = 0.5`. Hipoteza zerowa dotyczyła wartości parametru $\theta_0 = 3$, natomiast alternatywy — dziesięć różnych wartości parametru $\theta$: 0.5, 1, 1.5, 2, 2.5, 3, 3.5, 4, 4.5, 5. Dla każdej z tych wartości przeprowadzono $M = 1000$ replikacji testu.

Symulacje wykonano dla dwóch liczebności prób: $n = 20$ oraz $n = 50$.  
Na podstawie otrzymanych wartości p-value wyznaczono estymator mocy testu  oraz rozmiaru testu.

Na wykresie poniżej przedstawiono krzywe mocy testu dla obu wielkości prób.  
Dodatkowo zaznaczono:
- przerywaną linię poziomą odpowiadającą poziomowi istotności $\alpha = 0.05$,  
- przerywaną linię pionową dla $\theta_0 = 3$

```{r , echo=FALSE}
set.seed(666)
library(ggplot2)
typ_I <- function(t0,theta,n){
  X<-numeric(n)
  delta <-numeric(n)
  check <- 0
  
  while (check == 0){
    X<-numeric(n)
    delta <-numeric(n)
    X=rexp(n, theta)
    X <- sort(X)
    for(i in 1:n){
      if(X[i]>t0){
        X[i] <- t0
        delta[i] <- 0
        check <- 1
      }else{delta[i]<-1}}
  }
  czas <- sort(X)
  return(data.frame(czas = czas, delta = delta))
}
symulacja_moc <- function(theta,theta0,n,t0,alpha = 0.05,M=1000){
  count <- 0 
  for (i in (1:M)){
    x <- typ_I(t0,theta,n)
    r <- sum(x$delta)
    pv <- IW(x,t0,r,theta0,"two.sided")
    if (pv<= alpha){
      count = count +1
    }
  }
  return(count/M)
}
theta0 <- 3 
theta_list <- c(0.5,1,1.5,2,2.5,3,3.5,4,4.5,5,5.5)
n20 <- numeric(length(theta_list))
n50 <- numeric(length(theta_list))
for (i in 1:length(theta_list)){
  n20[i] <- symulacja_moc(theta_list[i],theta0,20,0.5)
  n50[i] <- symulacja_moc(theta_list[i],theta0,50,0.5)
}
  

df <- data.frame(
  theta = rep(theta_list, 2),
  moc = c(n20, n50),
  n = factor(rep(c(20, 50), each=length(theta_list)))
)

ggplot(df, aes(x=theta, y=moc, color=n, shape=n)) +
  geom_line(linewidth=1) +
  geom_point(size=3) +
  geom_hline(yintercept=0.05, linetype="dashed", color="gray40") +
  geom_vline(xintercept=theta0, linetype="dashed", color="gray40") +
  annotate("text", x=max(theta_list)-0.3, y=0.1, label='alpha=0.05',
           color="gray30", size=4, hjust=1) +
  annotate("text", x=theta0+0.4, y=0.9, label='theta_0 = 3',
           color="gray30", size=4, angle=90, vjust=-0.5) +
  scale_color_manual(values=c("blue", "red")) +
  labs(title="Krzywe mocy testu ilorazu wiarygodności",
       x='theta', y="Moc testu",
       color="Wielkość próby", shape="Wielkość próby") +
  theme_minimal(base_size=14)

rozmiar_20 <- symulacja_moc(theta0,theta0,20,0.5,0.05, M=1000)
rozmiar_50 <- symulacja_moc(theta0,theta0,50,0.5,0.05, M=1000)


```

Można zaobserwować, że wraz z oddalaniem się od naszego $\theta_0$ moc testu rośnie, a dla $\theta = \theta_0$ empiryczny rozmiar testu jest zbliżony do nominalnego poziomu $\alpha$ i wynosi dla $n = 20$: `r rozmiar_20` oraz dla $n = 50$: `r rozmiar_50`. Dodatkowo możemy zauważyć, że wraz ze wzrostem liczebności próby moc testu również rośnie.

## Zadanie 3

Zakładamy, że $\alpha$=0.05.
Korzystając z wcześniej napisanej funkcji IW, liczymy p-value dla danych pochodzących z listy 2. z zadania 3. Weryfikujemy hipotezę, że średni czas do remisji w grupie A i B wynosi 1.

```{r, warning=FALSE, echo=FALSE}
## dane z zad.3 listy 2
#R=10
n=20
t0=1
delta=numeric(n)
grupa_A <- numeric(n)
grupa_B <- numeric(n)

grupa_A[1:10] <- c(0.03345514, 0.08656403, 0.08799947, 0.24385821, 0.27755032,
0.40787247, 0.58825664, 0.64125620, 0.90679161, 0.94222208)

grupa_B[1:10] <- c(0.03788958, 0.12207257, 0.20319983, 0.24474299, 0.30492413,
0.34224462, 0.42950144, 0.44484582, 0.63805066, 0.69119721)

## cenzurowanie I-go typu

grupa_A[11:20] <- t0
grupa_B[11:20] <- t0

delta_A <- c(rep(1, 10), rep(0, 10))
delta_B <- c(rep(1, 10), rep(0, 10))

dane_A <- data.frame(czas = grupa_A, delta = delta_A)
dane_B <- data.frame(czas = grupa_B, delta = delta_B)
```

```{r}
p1 <- round(IW(dane_A,1,10,1,"two.sided"),2)
p2 <- round(IW(dane_B,1,10,1,"two.sided"),2)
```

Otrzymaliśmy wyniki p=`r p1` dla grupy A oraz p=`r p2` dla grupy B. Przy założeniu ustalonej $\alpha$ p>0.05 dla obu przypadków. Zatem nie ma podstaw do odrzucenia hipotezy ani w grupie A, ani w grupie B.


